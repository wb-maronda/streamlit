{"version":3,"file":"FileUploader.js","names":["axios","isEqual","zip","React","FileUploaderState","FileUploaderStateProto","UploadedFileInfo","UploadedFileInfoProto","FormClearHelper","FileSize","getSizeDisplay","sizeConverter","WidgetLabel","StyledWidgetLabelHelp","TooltipIcon","Placement","labelVisibilityProtoValueToEnum","FileDropzone","StyledFileUploader","UploadedFiles","UploadFileInfo","jsx","_jsx","jsxs","_jsxs","FileUploader","PureComponent","constructor","props","formClearHelper","localFileIdCounter","forceUpdatingStatus","componentDidUpdate","status","newWidgetValue","createWidgetValue","element","widgetMgr","fragmentId","prevWidgetValue","getFileUploaderStateValue","setFileUploaderStateValue","fromUi","reset","setState","files","dropHandler","acceptedFiles","rejectedFiles","multipleFiles","length","firstFileIndex","findIndex","file","errors","code","push","splice","uploadClient","fetchFileURLs","then","fileURLsArray","existingFile","state","find","f","type","deleteFile","id","forEach","_ref","fileURLs","acceptedFile","uploadFile","catch","errorMessage","addFiles","map","name","size","nextLocalFileId","rejectedInfos","rejected","getErrorMessage","cancelToken","CancelToken","source","uploadingFileInfo","progress","addFile","uploadUrl","e","onUploadProgress","token","onUploadComplete","err","isCancel","updateFile","setStatus","toString","localFileId","fileUrls","curFile","getFile","fileId","errorCode","concat","maxUploadSizeInBytes","Byte","cancel","deleteUrl","removeFile","idToRemove","filter","curFileId","newFile","curState","event","newProgress","Math","round","loaded","total","onFormCleared","initialValue","emptyState","newestServerFileId","widgetValue","uploadedFileInfo","componentWillUnmount","disconnect","maxMbs","maxUploadSizeMb","Megabyte","isFileUpdating","some","componentDidMount","undefined","render","_element$labelVisibil","disabled","acceptedExtensions","manageFormClearListener","formId","newestToOldestFiles","slice","reverse","children","label","labelVisibility","value","help","content","placement","TOP_RIGHT","onDrop","multiple","maxSizeBytes","items","pageSize","onDelete","resetOnAdd"],"sources":["../../../../src/components/widgets/FileUploader/FileUploader.tsx"],"sourcesContent":["/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2024)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport axios from \"axios\"\nimport isEqual from \"lodash/isEqual\"\nimport zip from \"lodash/zip\"\nimport React from \"react\"\nimport { FileRejection } from \"react-dropzone\"\n\nimport {\n  FileUploader as FileUploaderProto,\n  FileUploaderState as FileUploaderStateProto,\n  FileURLs as FileURLsProto,\n  IFileURLs,\n  UploadedFileInfo as UploadedFileInfoProto,\n} from \"@streamlit/lib/src/proto\"\nimport { FormClearHelper } from \"@streamlit/lib/src/components/widgets/Form\"\n\nimport {\n  FileSize,\n  getSizeDisplay,\n  sizeConverter,\n} from \"@streamlit/lib/src/util/FileHelper\"\nimport { FileUploadClient } from \"@streamlit/lib/src/FileUploadClient\"\nimport { WidgetStateManager } from \"@streamlit/lib/src/WidgetStateManager\"\nimport {\n  WidgetLabel,\n  StyledWidgetLabelHelp,\n} from \"@streamlit/lib/src/components/widgets/BaseWidget\"\nimport TooltipIcon from \"@streamlit/lib/src/components/shared/TooltipIcon\"\nimport { Placement } from \"@streamlit/lib/src/components/shared/Tooltip\"\nimport { labelVisibilityProtoValueToEnum } from \"@streamlit/lib/src/util/utils\"\nimport FileDropzone from \"./FileDropzone\"\nimport { StyledFileUploader } from \"./styled-components\"\nimport UploadedFiles from \"./UploadedFiles\"\nimport { UploadFileInfo, UploadedStatus } from \"./UploadFileInfo\"\n\nexport interface Props {\n  disabled: boolean\n  element: FileUploaderProto\n  widgetMgr: WidgetStateManager\n  uploadClient: FileUploadClient\n  width: number\n  fragmentId?: string\n}\n\ntype FileUploaderStatus =\n  | \"ready\" // FileUploader can upload or delete files\n  | \"updating\" // at least one file is being uploaded or deleted\n\nexport interface State {\n  /**\n   * List of files dropped on the FileUploader by the user. This list includes\n   * rejected files that will not be updated.\n   */\n  files: UploadFileInfo[]\n}\n\nclass FileUploader extends React.PureComponent<Props, State> {\n  private readonly formClearHelper = new FormClearHelper()\n\n  /**\n   * A counter for assigning unique internal IDs to each file tracked\n   * by the uploader. These IDs are used to update file state internally,\n   * and are separate from the serverFileIds that are returned by the server.\n   */\n  private localFileIdCounter = 1\n\n  /**\n   * A flag to handle the case where a file uploader that only accepts one file\n   * at a time has its file replaced, which we want to treat as a single change\n   * rather than the deletion of a file followed by the upload of another.\n   * Doing this ensures that the script (and thus callbacks, etc) is only run a\n   * single time when replacing a file.  Note that deleting a file and uploading\n   * a new one with two interactions (clicking the 'X', then dragging a file\n   * into the file uploader) will still cause the script to execute twice.\n   */\n  private forceUpdatingStatus = false\n\n  public constructor(props: Props) {\n    super(props)\n    this.state = this.initialValue\n  }\n\n  get initialValue(): State {\n    const emptyState = { files: [], newestServerFileId: 0 }\n    const { widgetMgr, element } = this.props\n\n    const widgetValue = widgetMgr.getFileUploaderStateValue(element)\n    if (widgetValue == null) {\n      return emptyState\n    }\n\n    const { uploadedFileInfo } = widgetValue\n    if (uploadedFileInfo == null || uploadedFileInfo.length === 0) {\n      return emptyState\n    }\n\n    return {\n      files: uploadedFileInfo.map(f => {\n        const name = f.name as string\n        const size = f.size as number\n\n        const fileId = f.fileId as string\n        const fileUrls = f.fileUrls as FileURLsProto\n\n        return new UploadFileInfo(name, size, this.nextLocalFileId(), {\n          type: \"uploaded\",\n          fileId,\n          fileUrls,\n        })\n      }),\n    }\n  }\n\n  public componentWillUnmount(): void {\n    this.formClearHelper.disconnect()\n  }\n\n  /**\n   * Return this.props.element.maxUploadSizeMb, converted to bytes.\n   */\n  private get maxUploadSizeInBytes(): number {\n    const maxMbs = this.props.element.maxUploadSizeMb\n    return sizeConverter(maxMbs, FileSize.Megabyte, FileSize.Byte)\n  }\n\n  /**\n   * Return the FileUploader's current status, which is derived from\n   * its state.\n   */\n  public get status(): FileUploaderStatus {\n    const isFileUpdating = (file: UploadFileInfo): boolean =>\n      file.status.type === \"uploading\"\n\n    // If any of our files is Uploading or Deleting, then we're currently\n    // updating.\n    if (this.state.files.some(isFileUpdating) || this.forceUpdatingStatus) {\n      return \"updating\"\n    }\n\n    return \"ready\"\n  }\n\n  public componentDidUpdate = (): void => {\n    // If our status is not \"ready\", then we have uploads in progress.\n    // We won't submit a new widgetValue until all uploads have resolved.\n    if (this.status !== \"ready\") {\n      return\n    }\n\n    const newWidgetValue = this.createWidgetValue()\n    const { element, widgetMgr, fragmentId } = this.props\n\n    // Maybe send a widgetValue update to the widgetStateManager.\n    const prevWidgetValue = widgetMgr.getFileUploaderStateValue(element)\n    if (!isEqual(newWidgetValue, prevWidgetValue)) {\n      widgetMgr.setFileUploaderStateValue(\n        element,\n        newWidgetValue,\n        {\n          fromUi: true,\n        },\n        fragmentId\n      )\n    }\n  }\n\n  public componentDidMount(): void {\n    const newWidgetValue = this.createWidgetValue()\n    const { element, widgetMgr, fragmentId } = this.props\n\n    // Set the state value on mount, to avoid triggering an extra rerun after\n    // the first rerun.\n    const prevWidgetValue = widgetMgr.getFileUploaderStateValue(element)\n    if (prevWidgetValue === undefined) {\n      widgetMgr.setFileUploaderStateValue(\n        element,\n        newWidgetValue,\n        {\n          fromUi: false,\n        },\n        fragmentId\n      )\n    }\n  }\n\n  private createWidgetValue(): FileUploaderStateProto {\n    const uploadedFileInfo: UploadedFileInfoProto[] = this.state.files\n      .filter(f => f.status.type === \"uploaded\")\n      .map(f => {\n        const { name, size, status } = f\n        const { fileId, fileUrls } = status as UploadedStatus\n        return new UploadedFileInfoProto({\n          fileId,\n          fileUrls,\n          name,\n          size,\n        })\n      })\n\n    return new FileUploaderStateProto({ uploadedFileInfo })\n  }\n\n  /**\n   * Clear files and errors, and reset the widget to its READY state.\n   */\n  private reset = (): void => {\n    this.setState({ files: [] })\n  }\n\n  /**\n   * Called by react-dropzone when files and drag-and-dropped onto the widget.\n   *\n   * @param acceptedFiles an array of files.\n   * @param rejectedFiles an array of FileRejections. A FileRejection\n   * encapsulates a File and an error indicating why it was rejected by\n   * the dropzone widget.\n   */\n  private dropHandler = (\n    acceptedFiles: File[],\n    rejectedFiles: FileRejection[]\n  ): void => {\n    const { element } = this.props\n    const { multipleFiles } = element\n\n    // If this is a single-file uploader and multiple files were dropped,\n    // all the files will be rejected. In this case, we pull out the first\n    // valid file into acceptedFiles, and reject the rest.\n    if (\n      !multipleFiles &&\n      acceptedFiles.length === 0 &&\n      rejectedFiles.length > 1\n    ) {\n      const firstFileIndex = rejectedFiles.findIndex(\n        file =>\n          file.errors.length === 1 && file.errors[0].code === \"too-many-files\"\n      )\n\n      if (firstFileIndex >= 0) {\n        acceptedFiles.push(rejectedFiles[firstFileIndex].file)\n        rejectedFiles.splice(firstFileIndex, 1)\n      }\n    }\n\n    this.props.uploadClient\n      .fetchFileURLs(acceptedFiles)\n      .then((fileURLsArray: IFileURLs[]) => {\n        // If this is a single-file uploader that already has an uploaded file,\n        // remove that file so that it can be replaced with our new one.\n        if (!multipleFiles && acceptedFiles.length > 0) {\n          const existingFile = this.state.files.find(\n            f => f.status.type !== \"error\"\n          )\n          if (existingFile) {\n            this.forceUpdatingStatus = true\n            this.deleteFile(existingFile.id)\n            this.forceUpdatingStatus = false\n          }\n        }\n\n        zip(fileURLsArray, acceptedFiles).forEach(\n          ([fileURLs, acceptedFile]) => {\n            this.uploadFile(fileURLs as FileURLsProto, acceptedFile as File)\n          }\n        )\n      })\n      .catch((errorMessage: string) => {\n        this.addFiles(\n          acceptedFiles.map(f => {\n            return new UploadFileInfo(f.name, f.size, this.nextLocalFileId(), {\n              type: \"error\",\n              errorMessage,\n            })\n          })\n        )\n      })\n\n    // Create an UploadFileInfo for each of our rejected files, and add them to\n    // our state.\n    if (rejectedFiles.length > 0) {\n      const rejectedInfos = rejectedFiles.map(rejected => {\n        const { file } = rejected\n        return new UploadFileInfo(\n          file.name,\n          file.size,\n          this.nextLocalFileId(),\n          {\n            type: \"error\",\n            errorMessage: this.getErrorMessage(\n              rejected.errors[0].code,\n              rejected.file\n            ),\n          }\n        )\n      })\n      this.addFiles(rejectedInfos)\n    }\n  }\n\n  public uploadFile = (fileURLs: IFileURLs, file: File): void => {\n    // Create an UploadFileInfo for this file and add it to our state.\n    const cancelToken = axios.CancelToken.source()\n    const uploadingFileInfo = new UploadFileInfo(\n      file.name,\n      file.size,\n      this.nextLocalFileId(),\n      {\n        type: \"uploading\",\n        cancelToken,\n        progress: 1,\n      }\n    )\n    this.addFile(uploadingFileInfo)\n\n    this.props.uploadClient\n      .uploadFile(\n        this.props.element,\n        fileURLs.uploadUrl as string,\n        file,\n        e => this.onUploadProgress(e, uploadingFileInfo.id),\n        cancelToken.token\n      )\n      .then(() => this.onUploadComplete(uploadingFileInfo.id, fileURLs))\n      .catch(err => {\n        // If this was a cancel error, we don't show the user an error -\n        // the cancellation was in response to an action they took.\n        if (!axios.isCancel(err)) {\n          this.updateFile(\n            uploadingFileInfo.id,\n            uploadingFileInfo.setStatus({\n              type: \"error\",\n              errorMessage: err ? err.toString() : \"Unknown error\",\n            })\n          )\n        }\n      })\n  }\n\n  /**\n   * Called when an upload has completed. Updates the file's status, and\n   * assigns it the new file ID returned from the server.\n   */\n  private onUploadComplete = (\n    localFileId: number,\n    fileUrls: IFileURLs\n  ): void => {\n    const curFile = this.getFile(localFileId)\n    if (curFile == null || curFile.status.type !== \"uploading\") {\n      // The file may have been canceled right before the upload\n      // completed. In this case, we just bail.\n      return\n    }\n\n    this.updateFile(\n      curFile.id,\n      curFile.setStatus({\n        type: \"uploaded\",\n        fileId: fileUrls.fileId as string,\n        fileUrls,\n      })\n    )\n  }\n\n  /**\n   * Return a human-readable message for the given error.\n   */\n  private getErrorMessage = (errorCode: string, file: File): string => {\n    switch (errorCode) {\n      case \"file-too-large\":\n        return `File must be ${getSizeDisplay(\n          this.maxUploadSizeInBytes,\n          FileSize.Byte\n        )} or smaller.`\n      case \"file-invalid-type\":\n        return `${file.type} files are not allowed.`\n      case \"file-too-small\":\n        // This should not fire.\n        return `File size is too small.`\n      case \"too-many-files\":\n        return \"Only one file is allowed.\"\n      default:\n        return \"Unexpected error. Please try again.\"\n    }\n  }\n\n  /**\n   * Delete the file with the given ID:\n   * - Cancel the file upload if it's in progress\n   * - Remove the fileID from our local state\n   * We don't actually tell the server to delete the file. It will garbage\n   * collect it.\n   */\n  public deleteFile = (fileId: number): void => {\n    const file = this.getFile(fileId)\n    if (file == null) {\n      return\n    }\n\n    if (file.status.type === \"uploading\") {\n      // The file hasn't been uploaded. Let's cancel the request.\n      // However, it may have been received by the server so we'll still\n      // send out a request to delete.\n      file.status.cancelToken.cancel()\n    }\n\n    if (file.status.type === \"uploaded\" && file.status.fileUrls.deleteUrl) {\n      this.props.uploadClient.deleteFile(file.status.fileUrls.deleteUrl)\n    }\n\n    this.removeFile(fileId)\n  }\n\n  /** Append the given file to `state.files`. */\n  private addFile = (file: UploadFileInfo): void => {\n    this.setState(state => ({ files: [...state.files, file] }))\n  }\n\n  /** Append the given files to `state.files`. */\n  private addFiles = (files: UploadFileInfo[]): void => {\n    this.setState(state => ({ files: [...state.files, ...files] }))\n  }\n\n  /** Remove the file with the given ID from `state.files`. */\n  private removeFile = (idToRemove: number): void => {\n    this.setState(state => ({\n      files: state.files.filter(file => file.id !== idToRemove),\n    }))\n  }\n\n  /**\n   * Return the file with the given ID, if one exists.\n   */\n  private getFile = (fileId: number): UploadFileInfo | undefined => {\n    return this.state.files.find(file => file.id === fileId)\n  }\n\n  /** Replace the file with the given id in `state.files`. */\n  private updateFile = (curFileId: number, newFile: UploadFileInfo): void => {\n    this.setState(curState => {\n      return {\n        files: curState.files.map(file =>\n          file.id === curFileId ? newFile : file\n        ),\n      }\n    })\n  }\n\n  /**\n   * Callback for file upload progress. Updates a single file's local `progress`\n   * state.\n   */\n  private onUploadProgress = (event: ProgressEvent, fileId: number): void => {\n    const file = this.getFile(fileId)\n    if (file == null || file.status.type !== \"uploading\") {\n      return\n    }\n\n    const newProgress = Math.round((event.loaded * 100) / event.total)\n    if (file.status.progress === newProgress) {\n      return\n    }\n\n    // Update file.progress\n    this.updateFile(\n      fileId,\n      file.setStatus({\n        type: \"uploading\",\n        cancelToken: file.status.cancelToken,\n        progress: newProgress,\n      })\n    )\n  }\n\n  /**\n   * If we're part of a clear_on_submit form, this will be called when our\n   * form is submitted. Restore our default value and update the WidgetManager.\n   */\n  private onFormCleared = (): void => {\n    this.setState({ files: [] }, () => {\n      const newWidgetValue = this.createWidgetValue()\n      if (newWidgetValue == null) {\n        return\n      }\n\n      const { widgetMgr, element, fragmentId } = this.props\n      widgetMgr.setFileUploaderStateValue(\n        element,\n        newWidgetValue,\n        { fromUi: true },\n        fragmentId\n      )\n    })\n  }\n\n  public render(): React.ReactNode {\n    const { files } = this.state\n    const { element, disabled, widgetMgr } = this.props\n    const acceptedExtensions = element.type\n\n    // Manage our form-clear event handler.\n    this.formClearHelper.manageFormClearListener(\n      widgetMgr,\n      element.formId,\n      this.onFormCleared\n    )\n\n    // We display files in the reverse order they were added.\n    // This way, if you have multiple pages of uploaded files and then drop\n    // another one, you'll see that newest file at the top of the first page.\n    const newestToOldestFiles = files.slice().reverse()\n\n    return (\n      <StyledFileUploader data-testid=\"stFileUploader\">\n        <WidgetLabel\n          label={element.label}\n          disabled={disabled}\n          labelVisibility={labelVisibilityProtoValueToEnum(\n            element.labelVisibility?.value\n          )}\n        >\n          {element.help && (\n            <StyledWidgetLabelHelp>\n              <TooltipIcon\n                content={element.help}\n                placement={Placement.TOP_RIGHT}\n              />\n            </StyledWidgetLabelHelp>\n          )}\n        </WidgetLabel>\n        <FileDropzone\n          onDrop={this.dropHandler}\n          multiple={element.multipleFiles}\n          acceptedExtensions={acceptedExtensions}\n          maxSizeBytes={this.maxUploadSizeInBytes}\n          label={element.label}\n          disabled={disabled}\n        />\n        {newestToOldestFiles.length > 0 && (\n          <UploadedFiles\n            items={newestToOldestFiles}\n            pageSize={3}\n            onDelete={this.deleteFile}\n            resetOnAdd\n          />\n        )}\n      </StyledFileUploader>\n    )\n  }\n\n  private nextLocalFileId(): number {\n    return this.localFileIdCounter++\n  }\n}\n\nexport default FileUploader\n"],"mappings":"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"}