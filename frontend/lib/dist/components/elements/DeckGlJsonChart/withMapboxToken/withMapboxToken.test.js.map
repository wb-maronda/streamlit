{"version":3,"file":"withMapboxToken.test.js","names":["React","axios","screen","waitFor","customRenderLibContext","render","DeckGlJsonChart","DeckGlJsonChartProto","withMapboxToken","MapboxTokenFetchingError","TOKENS_URL","jsx","_jsx","describe","mockMapboxToken","element","create","mapboxToken","emptyElement","getProps","label","width","jest","mock","MockComponent","props","children","DeltaType","WrappedComponent","LIB_CONFIG_TOKEN","beforeEach","resetAllMocks","it","mockComponentText","getByText","expect","toBeInTheDocument","displayName","toEqual","get","fn","mockImplementation","data","userMapboxToken","mockReturnValue","Promise","getByTestId","mockResolvedValue","mapbox","toHaveBeenCalledWith","wrappedComponentInstance","mockReturnValueOnce","ref","mockRejectedValueOnce","initMapboxToken","rejects","toThrow","libConfig","textContent","toBe"],"sources":["../../../../../src/components/elements/DeckGlJsonChart/withMapboxToken/withMapboxToken.test.tsx"],"sourcesContent":["/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2024)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { ReactElement } from \"react\"\n\nimport \"@testing-library/jest-dom\"\nimport axios from \"axios\"\nimport { screen, waitFor } from \"@testing-library/react\"\n\nimport { customRenderLibContext, render } from \"@streamlit/lib/src/test_util\"\nimport { DeckGlJsonChart as DeckGlJsonChartProto } from \"@streamlit/lib/src/proto\"\n\nimport withMapboxToken, {\n  MapboxTokenFetchingError,\n  TOKENS_URL,\n  WrappedMapboxProps,\n} from \"./withMapboxToken\"\n\ninterface TestProps {\n  label: string\n  width: number\n  mapboxToken: string\n}\n\ndescribe(\"withMapboxToken\", () => {\n  const mockMapboxToken = \"mockToken\"\n  const element = DeckGlJsonChartProto.create({\n    // mock .streamlit/config.toml token\n    mapboxToken: mockMapboxToken,\n  })\n\n  const emptyElement = DeckGlJsonChartProto.create({})\n\n  function getProps(): WrappedMapboxProps<TestProps> {\n    return {\n      label: \"mockLabel\",\n      width: 123,\n      element,\n    }\n  }\n\n  jest.mock(\"axios\")\n\n  // This component is only used to test whether or not the mapbox is correctly set\n  const MockComponent = (props: {\n    mapboxToken: string | undefined\n  }): ReactElement => (\n    <div data-testid=\"mock-component\">{props.mapboxToken}</div>\n  )\n\n  describe(\"withMapboxToken rendering\", () => {\n    const DeltaType = \"testDeltaType\"\n    const WrappedComponent = withMapboxToken(DeltaType)(MockComponent)\n    const LIB_CONFIG_TOKEN = \"LIB_TOKEN_CONFIG\"\n\n    beforeEach(() => {\n      jest.resetAllMocks()\n    })\n\n    it(\"renders without crashing\", () => {\n      const props = getProps()\n      render(<WrappedComponent {...props} />, {})\n      const mockComponentText = screen.getByText(mockMapboxToken)\n      expect(mockComponentText).toBeInTheDocument()\n    })\n\n    it(\"defines `displayName`\", () => {\n      expect(WrappedComponent.displayName).toEqual(\n        \"withMapboxToken(MockComponent)\"\n      )\n    })\n\n    it(\"should inject mapbox token to the wrapped component when available in the config.toml\", () => {\n      axios.get = jest.fn().mockImplementation(() => ({\n        data: { userMapboxToken: mockMapboxToken },\n      }))\n\n      render(<WrappedComponent element={element} width={500} />)\n\n      const mockComponentText = screen.getByText(mockMapboxToken)\n      expect(mockComponentText).toBeInTheDocument()\n    })\n\n    it(\"should render loading alert while fetching the token\", () => {\n      axios.get = jest.fn().mockReturnValue(new Promise(() => {}))\n      render(<WrappedComponent element={emptyElement} width={500} />)\n\n      expect(screen.getByTestId(\"stSkeleton\")).toBeInTheDocument()\n    })\n\n    it(\"should fetch the token if userMapboxToken is not present in config.toml and libConfig\", async () => {\n      axios.get = jest\n        .fn()\n        .mockResolvedValue({ data: { mapbox: mockMapboxToken } })\n\n      render(<WrappedComponent element={emptyElement} width={500} />)\n\n      await waitFor(() => {\n        expect(axios.get).toHaveBeenCalledWith(TOKENS_URL)\n      })\n    })\n\n    it(\"should throw an error if fetched token is not present\", async () => {\n      let wrappedComponentInstance: any\n      axios.get = jest\n        .fn()\n        .mockReturnValueOnce({ data: { mapbox: mockMapboxToken } })\n\n      render(\n        <WrappedComponent\n          ref={ref => {\n            wrappedComponentInstance = ref\n          }}\n          element={emptyElement}\n          width={500}\n        />\n      )\n\n      axios.get = jest.fn().mockRejectedValueOnce(\"ERROR\")\n      await expect(wrappedComponentInstance.initMapboxToken()).rejects.toThrow(\n        new MapboxTokenFetchingError(`ERROR (${TOKENS_URL})`)\n      )\n    })\n\n    it(\"should inject mapbox token to the wrapped component when available in the libConfig\", async () => {\n      axios.get = jest.fn().mockImplementation(() => ({\n        data: { userMapboxToken: mockMapboxToken },\n      }))\n\n      customRenderLibContext(\n        <WrappedComponent element={element} width={500} />,\n        {\n          libConfig: { mapboxToken: LIB_CONFIG_TOKEN },\n        }\n      )\n\n      await waitFor(() => {\n        const element = screen.getByTestId(\"mock-component\")\n        expect(element.textContent).toBe(mockMapboxToken)\n      })\n    })\n\n    it(\"prioritizes the libConfig token if no config.toml token and don't fetch our token\", async () => {\n      axios.get = jest\n        .fn()\n        .mockResolvedValue({ data: { mapbox: mockMapboxToken } })\n\n      customRenderLibContext(\n        <WrappedComponent element={emptyElement} width={500} />,\n        {\n          libConfig: { mapboxToken: LIB_CONFIG_TOKEN },\n        }\n      )\n\n      await waitFor(() => {\n        const element = screen.getByTestId(\"mock-component\")\n        expect(element.textContent).toBe(LIB_CONFIG_TOKEN)\n      })\n    })\n  })\n})\n"],"mappings":"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"}