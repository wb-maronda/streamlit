{"version":3,"file":"ArrowVegaLiteChart.js","names":["React","PureComponent","withTheme","embed","vega","expressionInterpreter","isEqual","debounce","notNullOrUndefined","isNullOrUndefined","logWarning","logMessage","withFullScreenWrapper","ensureError","FormClearHelper","getDataSets","getDataArray","dataIsAnAppendOfPrev","getDataArrays","getInlineData","applyStreamlitTheme","applyThemeDefaults","StyledVegaLiteChartContainer","jsx","_jsx","DEFAULT_DATA_NAME","BOTTOM_PADDING","DEBOUNCE_TIME_MS","prepareSpecForSelections","spec","params","forEach","param","includes","select","type","encodings","Object","keys","encoding","ArrowVegaLiteChart","constructor","arguments","vegaView","vegaFinalizer","defaultDataName","element","formClearHelper","state","error","undefined","finalizeView","generateSpec","_spec$usermeta","_spec$usermeta$embedO","el","theme","isFullScreen","width","height","props","JSON","parse","useContainerWidth","vegaLiteTheme","config","usermeta","embedOptions","vconcat","child","padding","bottom","datasets","Error","selectionMode","length","maybeConfigureSelections","widgetMgr","id","viewState","getElementState","setState","e","_index","_this$vegaView","addSignalListener","name","value","_this$vegaView2","getState","data","_operator","some","mode","concat","recurse","setElementState","processedSelection","vlPoint","or","currentWidgetState","getStringValue","updatedSelections","selection","setStringValue","stringify","fromUi","fragmentId","reset","emptySelectionState","currentWidgetStateStr","_this$props$widgetMgr","formId","manageFormClearListener","componentDidMount","createView","componentWillUnmount","componentDidUpdate","prevProps","prevElement","prevTheme","prevSpec","prevData","updateData","prevDataSets","dataSets","dataset","entries","datasetName","prevDataset","hasOwnProperty","resize","runAsync","numRows","remove","truthy","insert","dataRows","prevNumRows","dataColumns","prevNumCols","dimensions","numCols","options","ast","expr","tooltip","disableDefaultStyle","defaultStyle","forceActionsMenu","vgSpec","view","finalize","datasetNames","dataObj","render","ref","c"],"sources":["../../../../src/components/elements/ArrowVegaLiteChart/ArrowVegaLiteChart.tsx"],"sourcesContent":["/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2024)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { PureComponent } from \"react\"\n\nimport { withTheme } from \"@emotion/react\"\nimport embed from \"vega-embed\"\nimport * as vega from \"vega\"\nimport { SignalValue } from \"vega\"\nimport { expressionInterpreter } from \"vega-interpreter\"\nimport isEqual from \"lodash/isEqual\"\n\nimport {\n  WidgetInfo,\n  WidgetStateManager,\n} from \"@streamlit/lib/src/WidgetStateManager\"\nimport {\n  debounce,\n  notNullOrUndefined,\n  isNullOrUndefined,\n} from \"@streamlit/lib/src/util/utils\"\nimport { logWarning, logMessage } from \"@streamlit/lib/src/util/log\"\nimport { withFullScreenWrapper } from \"@streamlit/lib/src/components/shared/FullScreenWrapper\"\nimport { ensureError } from \"@streamlit/lib/src/util/ErrorHandling\"\nimport { Quiver } from \"@streamlit/lib/src/dataframes/Quiver\"\nimport { EmotionTheme } from \"@streamlit/lib/src/theme\"\nimport { FormClearHelper } from \"@streamlit/lib/src/components/widgets/Form\"\n\nimport \"@streamlit/lib/src/assets/css/vega-embed.css\"\nimport \"@streamlit/lib/src/assets/css/vega-tooltip.css\"\n\nimport {\n  getDataSets,\n  VegaLiteChartElement,\n  getDataArray,\n  dataIsAnAppendOfPrev,\n  getDataArrays,\n  getInlineData,\n} from \"./arrowUtils\"\nimport { applyStreamlitTheme, applyThemeDefaults } from \"./CustomTheme\"\nimport { StyledVegaLiteChartContainer } from \"./styled-components\"\n\nconst DEFAULT_DATA_NAME = \"source\"\n\n/**\n * Fix bug where Vega Lite was vertically-cropping the x-axis in some cases.\n * For example, in e2e/scripts/add_rows.py\n */\nconst BOTTOM_PADDING = 20\n\n/**\n * Debounce time for triggering a widget state update\n * This prevents to rapid updates to the widget state.\n */\nconst DEBOUNCE_TIME_MS = 150\n\n/** This is the state that is sent to the backend\n * This needs to be the same structure that is also defined\n * in the Python code.\n */\nexport interface VegaLiteState {\n  selection: Record<string, any>\n}\n\ninterface Props {\n  element: VegaLiteChartElement\n  theme: EmotionTheme\n  width: number\n  widgetMgr: WidgetStateManager\n  fragmentId?: string\n}\n\nexport interface PropsWithFullScreen extends Props {\n  height?: number\n  isFullScreen: boolean\n}\n\ninterface State {\n  error?: Error\n}\n\n/**\n * Prepares the vega-lite spec for selections by transforming the select parameters\n * to a full object specification and by automatically adding encodings (if missing)\n * to point selections.\n *\n * The changes are applied in-place to the spec object.\n *\n * @param spec The Vega-Lite specification of the chart.\n */\nexport function prepareSpecForSelections(spec: any): void {\n  if (\"params\" in spec && \"encoding\" in spec) {\n    spec.params.forEach((param: any) => {\n      if (!(\"select\" in param)) {\n        // We are only interested in transforming select parameters.\n        // Other parameters are skipped.\n        return\n      }\n\n      if ([\"interval\", \"point\"].includes(param.select)) {\n        // The select object can be either a single string (short-hand) specifying\n        // \"interval\" or \"point\" or an object that can contain additional\n        // properties as defined here: https://vega.github.io/vega-lite/docs/selection.html\n        // We convert the short-hand notation to the full object specification,\n        // so that we can attach additional properties to this below.\n        param.select = {\n          type: param.select,\n        }\n      }\n\n      if (!(\"type\" in param.select)) {\n        // The type property is required in the spec.\n        // But we check anyways and skip all parameters that don't have it.\n        return\n      }\n\n      if (\n        param.select.type === \"point\" &&\n        !(\"encodings\" in param.select) &&\n        isNullOrUndefined(param.select.encodings)\n      ) {\n        // If encodings are not specified by the user, we add all the encodings from\n        // the chart to the selection parameter. This is required so that points\n        // selections are correctly resolved to a PointSelection and not an IndexSelection:\n        // https://github.com/altair-viz/altair/issues/3285#issuecomment-1858860696\n        param.select.encodings = Object.keys(spec.encoding)\n      }\n    })\n  }\n}\n\nexport class ArrowVegaLiteChart extends PureComponent<\n  PropsWithFullScreen,\n  State\n> {\n  /**\n   * The Vega view object\n   */\n  private vegaView?: vega.View\n\n  /**\n   * Finalizer for the embedded vega object. Must be called to dispose\n   * of the vegaView when it's no longer used.\n   */\n  private vegaFinalizer?: () => void\n\n  /**\n   * The default data name to add to.\n   */\n  private defaultDataName = DEFAULT_DATA_NAME\n\n  /**\n   * The html element we attach the Vega view to.\n   */\n  private element: HTMLDivElement | null = null\n\n  /**\n   * Helper to manage form clear listeners.\n   * This is used to reset the selection state when the form is cleared.\n   */\n  private readonly formClearHelper = new FormClearHelper()\n\n  readonly state = {\n    error: undefined,\n  }\n\n  public async componentDidMount(): Promise<void> {\n    try {\n      await this.createView()\n    } catch (e) {\n      const error = ensureError(e)\n      this.setState({ error })\n    }\n  }\n\n  public componentWillUnmount(): void {\n    this.finalizeView()\n  }\n\n  /**\n   * Finalize the view so it can be garbage collected. This should be done\n   * when a new view is created, and when the component unmounts.\n   */\n  private finalizeView = (): any => {\n    if (this.vegaFinalizer) {\n      this.vegaFinalizer()\n    }\n    this.vegaFinalizer = undefined\n    this.vegaView = undefined\n  }\n\n  public async componentDidUpdate(\n    prevProps: PropsWithFullScreen\n  ): Promise<void> {\n    const { element: prevElement, theme: prevTheme } = prevProps\n    const { element, theme } = this.props\n\n    const prevSpec = prevElement.spec\n    const { spec } = element\n\n    if (\n      !this.vegaView ||\n      prevSpec !== spec ||\n      prevTheme !== theme ||\n      prevProps.width !== this.props.width ||\n      prevProps.height !== this.props.height ||\n      prevProps.element.vegaLiteTheme !== this.props.element.vegaLiteTheme ||\n      !isEqual(\n        prevProps.element.selectionMode,\n        this.props.element.selectionMode\n      )\n    ) {\n      logMessage(\"Vega spec changed.\")\n      try {\n        await this.createView()\n      } catch (e) {\n        const error = ensureError(e)\n\n        this.setState({ error })\n      }\n      return\n    }\n\n    const prevData = prevElement.data\n    const { data } = element\n\n    if (prevData || data) {\n      this.updateData(this.defaultDataName, prevData, data)\n    }\n\n    const prevDataSets = getDataSets(prevElement) || {}\n    const dataSets = getDataSets(element) || {}\n\n    for (const [name, dataset] of Object.entries(dataSets)) {\n      const datasetName = name || this.defaultDataName\n      const prevDataset = prevDataSets[datasetName]\n\n      this.updateData(datasetName, prevDataset, dataset)\n    }\n\n    // Remove all datasets that are in the previous but not the current datasets.\n    for (const name of Object.keys(prevDataSets)) {\n      if (!dataSets.hasOwnProperty(name) && name !== this.defaultDataName) {\n        this.updateData(name, null, null)\n      }\n    }\n\n    this.vegaView.resize().runAsync()\n  }\n\n  public generateSpec = (): any => {\n    const { element: el, theme, isFullScreen, width, height } = this.props\n    const spec = JSON.parse(el.spec)\n    const { useContainerWidth } = el\n    if (el.vegaLiteTheme === \"streamlit\") {\n      spec.config = applyStreamlitTheme(spec.config, theme)\n    } else if (spec.usermeta?.embedOptions?.theme === \"streamlit\") {\n      spec.config = applyStreamlitTheme(spec.config, theme)\n      // Remove the theme from the usermeta so it doesn't get picked up by vega embed.\n      spec.usermeta.embedOptions.theme = undefined\n    } else {\n      // Apply minor theming improvements to work better with Streamlit\n      spec.config = applyThemeDefaults(spec.config, theme)\n    }\n\n    if (isFullScreen) {\n      spec.width = width\n      spec.height = height\n\n      if (\"vconcat\" in spec) {\n        spec.vconcat.forEach((child: any) => {\n          child.width = width\n        })\n      }\n    } else if (useContainerWidth) {\n      spec.width = width\n\n      if (\"vconcat\" in spec) {\n        spec.vconcat.forEach((child: any) => {\n          child.width = width\n        })\n      }\n    }\n\n    if (!spec.padding) {\n      spec.padding = {}\n    }\n\n    if (spec.padding.bottom == null) {\n      spec.padding.bottom = BOTTOM_PADDING\n    }\n\n    if (spec.datasets) {\n      throw new Error(\"Datasets should not be passed as part of the spec\")\n    }\n\n    if (el.selectionMode.length > 0) {\n      prepareSpecForSelections(spec)\n    }\n    return spec\n  }\n\n  /**\n   * Update the dataset in the Vega view. This method tried to minimize changes\n   * by automatically creating and applying diffs.\n   *\n   * @param name The name of the dataset.\n   * @param prevData The dataset before the update.\n   * @param data The dataset to use for the update.\n   */\n  private updateData(\n    name: string,\n    prevData: Quiver | null,\n    data: Quiver | null\n  ): void {\n    if (!this.vegaView) {\n      throw new Error(\"Chart has not been drawn yet\")\n    }\n\n    if (!data || data.data.numRows === 0) {\n      // The new data is empty, so we remove the dataset from the\n      // chart view if the named dataset exists.\n      try {\n        this.vegaView.remove(name, vega.truthy)\n      } finally {\n        return\n      }\n    }\n\n    if (!prevData || prevData.data.numRows === 0) {\n      // The previous data was empty, so we just insert the new data.\n      this.vegaView.insert(name, getDataArray(data))\n      return\n    }\n\n    const { dataRows: prevNumRows, dataColumns: prevNumCols } =\n      prevData.dimensions\n    const { dataRows: numRows, dataColumns: numCols } = data.dimensions\n\n    // Check if dataframes have same \"shape\" but the new one has more rows.\n    if (\n      dataIsAnAppendOfPrev(\n        prevData,\n        prevNumRows,\n        prevNumCols,\n        data,\n        numRows,\n        numCols\n      )\n    ) {\n      if (prevNumRows < numRows) {\n        // Insert the new rows.\n        this.vegaView.insert(name, getDataArray(data, prevNumRows))\n      }\n    } else {\n      // Clean the dataset and insert from scratch.\n      this.vegaView.data(name, getDataArray(data))\n      logMessage(\n        `Had to clear the ${name} dataset before inserting data through Vega view.`\n      )\n    }\n  }\n\n  /**\n   * Configure the selections for this chart if the chart has selections enabled.\n   */\n  private maybeConfigureSelections = (): void => {\n    if (this.vegaView === undefined) {\n      // This check is mainly to make the type checker happy.\n      // this.vegaView is guaranteed to be defined here.\n      return\n    }\n\n    const { widgetMgr, element } = this.props\n\n    if (!element?.id || element.selectionMode.length === 0) {\n      // To configure selections, it needs to be activated and\n      // the element ID must be set.\n      return\n    }\n\n    // Try to load the previous state of the chart from the element state.\n    // This is useful to restore the selection state when the component is re-mounted\n    // or when its put into fullscreen mode.\n    const viewState = widgetMgr.getElementState(\n      this.props.element.id,\n      \"viewState\"\n    )\n    if (notNullOrUndefined(viewState)) {\n      try {\n        this.vegaView = this.vegaView.setState(viewState)\n      } catch (e) {\n        logWarning(\"Failed to restore view state\", e)\n      }\n    }\n\n    // Add listeners for all selection events. Find out more here:\n    // https://vega.github.io/vega/docs/api/view/#view_addSignalListener\n    element.selectionMode.forEach((param, _index) => {\n      this.vegaView?.addSignalListener(\n        param,\n        debounce(DEBOUNCE_TIME_MS, (name: string, value: SignalValue) => {\n          // Store the current chart selection state with the widget manager so that it\n          // can be used for restoring the state when the component unmounted and\n          // created again. This can happen when elements are added before it within\n          // the delta path. The viewState is only stored in the frontend, and not\n          // synced to the backend.\n          const viewState = this.vegaView?.getState({\n            // There are also `signals` data, but I believe its\n            // not relevant for restoring the selection state.\n            data: (name?: string, _operator?: any) => {\n              // Vega lite stores the selection state in a <param name>_store parameter\n              // under `data` that can be retrieved via the getState method.\n              // https://vega.github.io/vega/docs/api/view/#view_getState\n              return element.selectionMode.some(\n                mode => `${mode}_store` === name\n              )\n            },\n            // Don't include subcontext data since it will lead to exceptions\n            // when loading the state.\n            recurse: false,\n          })\n\n          if (notNullOrUndefined(viewState)) {\n            widgetMgr.setElementState(element.id, \"viewState\", viewState)\n          }\n\n          // If selection encodings are correctly specified, vega-lite will return\n          // a list of selected points within the vlPoint.or property:\n          // https://github.com/vega/altair/blob/f1b4e2c84da2fba220022c8a285cc8280f824ed8/altair/utils/selection.py#L50\n          // We want to just return this list of points instead of the entire object\n          // since the other parts of the selection object are not useful.\n          let processedSelection = value\n          if (\"vlPoint\" in value && \"or\" in value.vlPoint) {\n            processedSelection = value.vlPoint.or\n          }\n\n          // Get the current widget state\n          const currentWidgetState = JSON.parse(\n            widgetMgr.getStringValue(element as WidgetInfo) || \"{}\"\n          )\n\n          // Update the component-internal selection state\n          const updatedSelections = {\n            selection: {\n              ...(currentWidgetState?.selection || {}),\n              [name]: processedSelection || {},\n            } as VegaLiteState,\n          }\n\n          // Update the widget state if the selection state has changed\n          // compared to the last update. This selection state will be synced\n          // with the backend.\n          if (!isEqual(currentWidgetState, updatedSelections)) {\n            widgetMgr.setStringValue(\n              element as WidgetInfo,\n              JSON.stringify(updatedSelections),\n              {\n                fromUi: true,\n              },\n              this.props.fragmentId\n            )\n          }\n        })\n      )\n    })\n\n    /**\n     * Callback to reset the selection and update the widget state.\n     * This might also send the empty selection state to the backend.\n     */\n    const reset = (): void => {\n      const emptySelectionState: VegaLiteState = {\n        selection: {},\n      }\n      // Initialize all parameters defined in the selectionMode with an empty object.\n      this.props.element.selectionMode.forEach(param => {\n        emptySelectionState.selection[param] = {}\n      })\n      const currentWidgetStateStr = widgetMgr.getStringValue(\n        element as WidgetInfo\n      )\n      const currentWidgetState = currentWidgetStateStr\n        ? JSON.parse(currentWidgetStateStr)\n        : // If there wasn't any selection yet, the selection state\n          // is assumed to be empty.\n          emptySelectionState\n\n      if (!isEqual(currentWidgetState, emptySelectionState)) {\n        this.props.widgetMgr?.setStringValue(\n          this.props.element as WidgetInfo,\n          JSON.stringify(emptySelectionState),\n          {\n            fromUi: true,\n          },\n          this.props.fragmentId\n        )\n      }\n    }\n\n    // Add the form clear listener if we are in a form (formId defined)\n    if (this.props.element.formId) {\n      this.formClearHelper.manageFormClearListener(\n        this.props.widgetMgr,\n        this.props.element.formId,\n        reset\n      )\n    }\n  }\n\n  /**\n   * Create a new Vega view and add the data.\n   */\n  private async createView(): Promise<void> {\n    logMessage(\"Creating a new Vega view.\")\n\n    if (!this.element) {\n      throw Error(\"Element missing.\")\n    }\n\n    // Finalize the previous view so it can be garbage collected.\n    this.finalizeView()\n\n    const { element } = this.props\n    const spec = this.generateSpec()\n    const options = {\n      // Adds interpreter support for Vega expressions that is compliant with CSP\n      ast: true,\n      expr: expressionInterpreter,\n\n      // Disable default styles so that vega doesn't inject <style> tags in the\n      // DOM. We set these styles manually for finer control over them and to\n      // avoid inlining styles.\n      tooltip: { disableDefaultStyle: true },\n      defaultStyle: false,\n      forceActionsMenu: true,\n    }\n\n    const { vgSpec, view, finalize } = await embed(this.element, spec, options)\n\n    this.vegaView = view\n\n    this.maybeConfigureSelections()\n\n    this.vegaFinalizer = finalize\n\n    const datasets = getDataArrays(element)\n\n    // Heuristic to determine the default dataset name.\n    const datasetNames = datasets ? Object.keys(datasets) : []\n    if (datasetNames.length === 1) {\n      const [datasetName] = datasetNames\n      this.defaultDataName = datasetName\n    } else if (datasetNames.length === 0 && vgSpec.data) {\n      this.defaultDataName = DEFAULT_DATA_NAME\n    }\n\n    const dataObj = getInlineData(element)\n    if (dataObj) {\n      view.insert(this.defaultDataName, dataObj)\n    }\n    if (datasets) {\n      for (const [name, data] of Object.entries(datasets)) {\n        view.insert(name, data)\n      }\n    }\n\n    await view.runAsync()\n\n    // Fix bug where the \"...\" menu button overlaps with charts where width is\n    // set to -1 on first load.\n    this.vegaView.resize().runAsync()\n  }\n\n  public render(): JSX.Element {\n    if (this.state.error) {\n      // eslint-disable-next-line @typescript-eslint/no-throw-literal\n      throw this.state.error\n    }\n\n    return (\n      // Create the container Vega draws inside.\n      <StyledVegaLiteChartContainer\n        data-testid=\"stArrowVegaLiteChart\"\n        useContainerWidth={this.props.element.useContainerWidth}\n        isFullScreen={this.props.isFullScreen}\n        ref={c => {\n          this.element = c\n        }}\n      />\n    )\n  }\n}\n\nexport default withTheme(withFullScreenWrapper(ArrowVegaLiteChart))\n"],"mappings":"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"}