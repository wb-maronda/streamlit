{"version":3,"file":"Video.js","names":["React","useEffect","useRef","useMemo","Video","VideoProto","IS_DEV_ENV","jsx","_jsx","DEFAULT_HEIGHT","_ref","element","width","endpoints","elementMgr","videoRef","type","url","startTime","subtitles","endTime","loop","autoplay","muted","preventAutoplay","id","getElementState","setElementState","current","currentTime","videoNode","setStartTime","addEventListener","removeEventListener","stoppedByEndTime","handleTimeUpdate","play","pause","handleVideoEnd","getYoutubeSrc","youtubeUrl","URL","isNaN","searchParams","append","toString","videoId","pathname","split","pop","Type","YOUTUBE_IFRAME","height","title","src","style","colorScheme","frameBorder","allow","allowFullScreen","ref","controls","autoPlay","buildMediaURL","className","undefined","crossOrigin","length","children","map","subtitle","idx","kind","label","default"],"sources":["../../../../src/components/elements/Video/Video.tsx"],"sourcesContent":["/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2024)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { ReactElement, useEffect, useRef, useMemo } from \"react\"\nimport { Video as VideoProto } from \"@streamlit/lib/src/proto\"\nimport { StreamlitEndpoints } from \"@streamlit/lib/src/StreamlitEndpoints\"\nimport { IS_DEV_ENV } from \"@streamlit/lib/src/baseconsts\"\nimport { WidgetStateManager as ElementStateManager } from \"@streamlit/lib/src/WidgetStateManager\"\n\nconst DEFAULT_HEIGHT = 528\n\nexport interface VideoProps {\n  endpoints: StreamlitEndpoints\n  width: number\n  element: VideoProto\n  elementMgr: ElementStateManager\n}\n\nexport interface Subtitle {\n  label: string\n  url: string\n}\n\nexport default function Video({\n  element,\n  width,\n  endpoints,\n  elementMgr,\n}: VideoProps): ReactElement {\n  const videoRef = useRef<HTMLVideoElement>(null)\n\n  /* Element may contain \"url\" or \"data\" property. */\n  const { type, url, startTime, subtitles, endTime, loop, autoplay, muted } =\n    element\n\n  const preventAutoplay = useMemo<boolean>(() => {\n    if (!element.id) {\n      // Elements without an ID should never autoplay\n      return true\n    }\n\n    // Recover the state in case this component got unmounted\n    // and mounted again for the same element.\n    const preventAutoplay = elementMgr.getElementState(\n      element.id,\n      \"preventAutoplay\"\n    )\n\n    if (!preventAutoplay) {\n      // Set the state to prevent autoplay in case there is an unmount + mount\n      // for the same element.\n      elementMgr.setElementState(element.id, \"preventAutoplay\", true)\n    }\n    return preventAutoplay ?? false\n  }, [element.id, elementMgr])\n\n  // Handle startTime changes\n  useEffect(() => {\n    if (videoRef.current) {\n      videoRef.current.currentTime = startTime\n    }\n  }, [startTime])\n\n  useEffect(() => {\n    const videoNode = videoRef.current\n\n    const setStartTime: () => void = () => {\n      if (videoNode) {\n        videoNode.currentTime = element.startTime\n      }\n    }\n\n    if (videoNode) {\n      videoNode.addEventListener(\"loadedmetadata\", setStartTime)\n    }\n\n    return () => {\n      if (videoNode) {\n        videoNode.removeEventListener(\"loadedmetadata\", setStartTime)\n      }\n    }\n  }, [element])\n\n  // Stop the video at 'endTime' and handle loop\n  useEffect(() => {\n    const videoNode = videoRef.current\n    if (!videoNode) return\n\n    // Flag to avoid calling 'videoNode.pause()' multiple times\n    let stoppedByEndTime = false\n\n    const handleTimeUpdate = (): void => {\n      if (endTime > 0 && videoNode.currentTime >= endTime) {\n        if (loop) {\n          // If loop is true and we reached 'endTime', reset to 'startTime'\n          videoNode.currentTime = startTime || 0\n          videoNode.play()\n        } else if (!stoppedByEndTime) {\n          stoppedByEndTime = true\n          videoNode.pause()\n        }\n      }\n    }\n\n    if (endTime > 0) {\n      videoNode.addEventListener(\"timeupdate\", handleTimeUpdate)\n    }\n\n    return () => {\n      if (videoNode && endTime > 0) {\n        videoNode.removeEventListener(\"timeupdate\", handleTimeUpdate)\n      }\n    }\n  }, [endTime, loop, startTime])\n\n  // Handle looping the video\n  useEffect(() => {\n    const videoNode = videoRef.current\n    if (!videoNode) return\n\n    // Loop the video when it has ended\n    const handleVideoEnd = (): void => {\n      if (loop) {\n        videoNode.currentTime = startTime || 0 // Reset to startTime or to the start if not specified\n        videoNode.play()\n      }\n    }\n\n    videoNode.addEventListener(\"ended\", handleVideoEnd)\n\n    return () => {\n      if (videoNode) {\n        videoNode.removeEventListener(\"ended\", handleVideoEnd)\n      }\n    }\n  }, [loop, startTime])\n\n  const getYoutubeSrc = (url: string): string => {\n    const { startTime, endTime, loop, autoplay, muted } = element\n    const youtubeUrl = new URL(url)\n\n    if (startTime && !isNaN(startTime)) {\n      youtubeUrl.searchParams.append(\"start\", startTime.toString())\n    }\n\n    if (endTime && !isNaN(endTime)) {\n      youtubeUrl.searchParams.append(\"end\", endTime.toString())\n    }\n\n    if (loop) {\n      youtubeUrl.searchParams.append(\"loop\", \"1\")\n      // When using the loop parameter, YouTube requires the playlist parameter to be set to the same video ID\n      const videoId = youtubeUrl.pathname.split(\"/\").pop()\n\n      if (videoId) {\n        youtubeUrl.searchParams.append(\"playlist\", videoId)\n      }\n    }\n\n    if (autoplay) {\n      youtubeUrl.searchParams.append(\"autoplay\", \"1\")\n    }\n\n    if (muted) {\n      youtubeUrl.searchParams.append(\"mute\", \"1\")\n    }\n\n    return youtubeUrl.toString()\n  }\n\n  /* Is this a YouTube link? If so we need a fancier tag.\n       NOTE: This part assumes the URL is already an \"embed\" link.\n    */\n  if (type === VideoProto.Type.YOUTUBE_IFRAME) {\n    // At some point the width 0 will be passed to this component\n    // which is caused by the AutoSizer of the VerticalLayout\n    // Width 0 will result in height being 0, which results in issue\n    // https://github.com/streamlit/streamlit/issues/5069\n    // To avoid this, when we detect width is 0, we set height to 528,\n    // which is default height based on the default streamlit width\n    const height = width !== 0 ? width * 0.75 : DEFAULT_HEIGHT\n\n    return (\n      <iframe\n        data-testid=\"stVideo\"\n        title={url}\n        src={getYoutubeSrc(url)}\n        width={width}\n        height={height}\n        style={{ colorScheme: \"normal\" }}\n        frameBorder=\"0\"\n        allow=\"autoplay; encrypted-media\"\n        allowFullScreen\n      />\n    )\n  }\n\n  // Only in dev mode we set crossOrigin to \"anonymous\" to avoid CORS issues\n  // when streamlit frontend and backend are running on different ports\n  return (\n    <video\n      data-testid=\"stVideo\"\n      ref={videoRef}\n      controls\n      muted={muted}\n      autoPlay={autoplay && !preventAutoplay}\n      src={endpoints.buildMediaURL(url)}\n      className=\"stVideo\"\n      style={{ width, height: width === 0 ? DEFAULT_HEIGHT : undefined }}\n      crossOrigin={\n        IS_DEV_ENV && subtitles.length > 0 ? \"anonymous\" : undefined\n      }\n    >\n      {subtitles &&\n        subtitles.map((subtitle: Subtitle, idx: number) => (\n          <track\n            key={idx}\n            kind=\"captions\"\n            src={endpoints.buildMediaURL(subtitle.url)}\n            label={subtitle.label}\n            default={idx === 0}\n          />\n        ))}\n    </video>\n  )\n}\n"],"mappings":"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"}