{"version":3,"file":"HostCommunicationManager.js","names":["isValidOrigin","Resolver","HOST_COMM_VERSION","HostCommunicationManager","constructor","props","allowedOrigins","deferredAuthToken","openHostCommunication","window","addEventListener","receiveHostMessage","sendMessageToHost","type","closeHostCommunication","removeEventListener","resetAuthToken","claimAuthToken","promise","setAllowedOrigins","_ref","useExternalAuthToken","resolve","undefined","length","message","parent","postMessage","stCommVersion","event","data","find","allowed","origin","closeModal","stopScript","rerunScript","clearCache","pageChanged","pageScriptHash","sendAppHeartbeat","setInputsDisabled","disabled","authToken","jwtHeaderName","jwtHeaderChanged","isOwnerChanged","isOwner","hostMenuItemsChanged","items","deployedAppMetadataChanged","metadata","pageLinkBaseUrlChanged","pageLinkBaseUrl","sidebarChevronDownshiftChanged","sidebarChevronDownshift","hostHideSidebarNavChanged","hidden","hostToolbarItemsChanged","queryParamsChanged","queryParams","sendRerunBackMsg","location","hash","themeChanged","themeName","themeInfo","restartWebsocketConnection","terminateWebsocketConnection"],"sources":["../../src/hostComm/HostCommunicationManager.tsx"],"sourcesContent":["/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2024)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ICustomThemeConfig, WidgetStates } from \"@streamlit/lib/src/proto\"\nimport { isValidOrigin } from \"@streamlit/lib/src/util/UriUtil\"\nimport { PresetThemeName } from \"@streamlit/lib/src/theme/types\"\nimport Resolver from \"@streamlit/lib/src/util/Resolver\"\n\nimport {\n  AppConfig,\n  DeployedAppMetadata,\n  IGuestToHostMessage,\n  IHostToGuestMessage,\n  IMenuItem,\n  IToolbarItem,\n  VersionedMessage,\n} from \"./types\"\n\nexport const HOST_COMM_VERSION = 1\n\nexport interface HostCommunicationProps {\n  readonly sendRerunBackMsg: (\n    widgetStates?: WidgetStates,\n    pageScriptHash?: string\n  ) => void\n  readonly closeModal: () => void\n  readonly stopScript: () => void\n  readonly rerunScript: () => void\n  readonly clearCache: () => void\n  readonly sendAppHeartbeat: () => void\n  readonly setInputsDisabled: (inputsDisabled: boolean) => void\n  readonly themeChanged: (\n    themeName?: PresetThemeName,\n    themeInfo?: ICustomThemeConfig\n  ) => void\n  readonly pageChanged: (pageScriptHash: string) => void\n  readonly isOwnerChanged: (isOwner: boolean) => void\n  readonly jwtHeaderChanged: (jwtPayload: {\n    jwtHeaderName: string\n    jwtHeaderValue: string\n  }) => void\n  readonly hostMenuItemsChanged: (menuItems: IMenuItem[]) => void\n  readonly hostToolbarItemsChanged: (toolbarItems: IToolbarItem[]) => void\n  readonly hostHideSidebarNavChanged: (hideSidebarNav: boolean) => void\n  readonly sidebarChevronDownshiftChanged: (\n    sidebarChevronDownshift: number\n  ) => void\n  readonly pageLinkBaseUrlChanged: (pageLinkBaseUrl: string) => void\n  readonly queryParamsChanged: (queryParams: string) => void\n  readonly deployedAppMetadataChanged: (\n    deployedAppMetadata: DeployedAppMetadata\n  ) => void\n  readonly restartWebsocketConnection: () => void\n  readonly terminateWebsocketConnection: () => void\n}\n\n/**\n * Manages host communication & messaging\n */\nexport default class HostCommunicationManager {\n  private readonly props: HostCommunicationProps\n\n  private allowedOrigins: string[]\n\n  private deferredAuthToken: Resolver<string | undefined>\n\n  constructor(props: HostCommunicationProps) {\n    this.props = props\n\n    this.allowedOrigins = []\n    this.deferredAuthToken = new Resolver()\n  }\n\n  /**\n   * Adds a listener for messages from the host\n   * sends message that guest is ready to receive messages\n   */\n  public openHostCommunication = (): void => {\n    window.addEventListener(\"message\", this.receiveHostMessage)\n    this.sendMessageToHost({ type: \"GUEST_READY\" })\n  }\n\n  /**\n   * Cleans up message event listener\n   */\n  public closeHostCommunication = (): void => {\n    window.removeEventListener(\"message\", this.receiveHostMessage)\n  }\n\n  /**\n   * Function to reset deferredAuthToken once the resource waiting on the token\n   * (that is, the WebsocketConnection singleton) has successfully received it.\n   *\n   * This should be called in a .then() handler attached to deferredAuthToken.promise.\n   */\n  public resetAuthToken = (): void => {\n    this.deferredAuthToken = new Resolver()\n  }\n\n  /**\n   * Function returning a promise that resolves to the auth token sent by the host\n   * Used by connectionManager\n   */\n  public claimAuthToken = (): Promise<string | undefined> => {\n    return this.deferredAuthToken.promise\n  }\n\n  /**\n   * Sets the allowed origins configuration.\n   */\n  public setAllowedOrigins = ({\n    allowedOrigins,\n    useExternalAuthToken,\n  }: AppConfig): void => {\n    if (!useExternalAuthToken) {\n      this.deferredAuthToken.resolve(undefined)\n    }\n    if (!allowedOrigins?.length) {\n      return\n    }\n    this.allowedOrigins = allowedOrigins\n\n    this.openHostCommunication()\n  }\n\n  /**\n   * Register a function to deliver a message to the Host\n   */\n  public sendMessageToHost = (message: IGuestToHostMessage): void => {\n    window.parent.postMessage(\n      {\n        stCommVersion: HOST_COMM_VERSION,\n        ...message,\n      } as VersionedMessage<IGuestToHostMessage>,\n      \"*\"\n    )\n  }\n\n  /**\n   * Register a function to handle a message from the Host\n   */\n  public receiveHostMessage = (event: MessageEvent): void => {\n    const message: VersionedMessage<IHostToGuestMessage> | any = event.data\n\n    // Messages coming from the parent frame of a deployed Streamlit app\n    // may not be coming from a trusted source (even if we've set the CSP\n    // frame-anscestors header, it doesn't hurt to be extra safe). We avoid\n    // processing messages received from origins we haven't explicitly\n    // labeled as trusted here to lower the probability that we end up\n    // processing malicious input.\n    if (\n      message.stCommVersion !== HOST_COMM_VERSION ||\n      !this.allowedOrigins.find(allowed =>\n        isValidOrigin(allowed, event.origin)\n      )\n    ) {\n      return\n    }\n\n    if (message.type === \"CLOSE_MODAL\") {\n      this.props.closeModal()\n    }\n\n    if (message.type === \"STOP_SCRIPT\") {\n      this.props.stopScript()\n    }\n\n    if (message.type === \"RERUN_SCRIPT\") {\n      this.props.rerunScript()\n    }\n\n    if (message.type === \"CLEAR_CACHE\") {\n      this.props.clearCache()\n    }\n\n    if (message.type === \"REQUEST_PAGE_CHANGE\") {\n      this.props.pageChanged(message.pageScriptHash)\n    }\n\n    if (message.type === \"SEND_APP_HEARTBEAT\") {\n      this.props.sendAppHeartbeat()\n    }\n\n    if (message.type === \"SET_INPUTS_DISABLED\") {\n      this.props.setInputsDisabled(message.disabled)\n    }\n\n    if (message.type === \"SET_AUTH_TOKEN\") {\n      // NOTE: The edge case (that should technically never happen) where\n      // useExternalAuthToken is false but we still receive this message\n      // type isn't an issue here because resolving a promise a second time\n      // is a no-op, and we already resolved the promise to undefined\n      // above.\n      this.deferredAuthToken.resolve(message.authToken)\n      if (message.jwtHeaderName !== undefined) {\n        this.props.jwtHeaderChanged(message)\n      }\n    }\n\n    if (message.type === \"SET_IS_OWNER\") {\n      this.props.isOwnerChanged(message.isOwner)\n    }\n\n    if (message.type === \"SET_MENU_ITEMS\") {\n      this.props.hostMenuItemsChanged(message.items)\n    }\n\n    if (message.type === \"SET_METADATA\") {\n      this.props.deployedAppMetadataChanged(message.metadata)\n    }\n\n    if (message.type === \"SET_PAGE_LINK_BASE_URL\") {\n      this.props.pageLinkBaseUrlChanged(message.pageLinkBaseUrl)\n    }\n\n    if (message.type === \"SET_SIDEBAR_CHEVRON_DOWNSHIFT\") {\n      this.props.sidebarChevronDownshiftChanged(\n        message.sidebarChevronDownshift\n      )\n    }\n\n    if (message.type === \"SET_SIDEBAR_NAV_VISIBILITY\") {\n      this.props.hostHideSidebarNavChanged(message.hidden)\n    }\n\n    if (message.type === \"SET_TOOLBAR_ITEMS\") {\n      this.props.hostToolbarItemsChanged(message.items)\n    }\n\n    if (message.type === \"UPDATE_FROM_QUERY_PARAMS\") {\n      this.props.queryParamsChanged(message.queryParams)\n      this.props.sendRerunBackMsg()\n    }\n\n    if (message.type === \"UPDATE_HASH\") {\n      window.location.hash = message.hash\n    }\n\n    if (message.type === \"SET_CUSTOM_THEME_CONFIG\") {\n      this.props.themeChanged(message.themeName, message.themeInfo)\n    }\n\n    if (message.type === \"RESTART_WEBSOCKET_CONNECTION\") {\n      this.props.restartWebsocketConnection()\n    }\n\n    if (message.type === \"TERMINATE_WEBSOCKET_CONNECTION\") {\n      this.props.terminateWebsocketConnection()\n    }\n  }\n}\n"],"mappings":"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"}