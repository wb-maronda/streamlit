{"version":3,"file":"RerunAnalyzer.js","names":["findNextEventIndex","findPrevEvent","findPrevEventIndex","getTimeDelta","isHandleMessageEvent","RerunAnalyzer","constructor","allEvents","lastEventIndex","rerunEvents","requestedRerun","getResults","messageIndexes","Set","forEach","evt","add","messageIndex","size","sortedMessageIndexes","Array","from","sort","compareNumbers","lastRerunEvent","length","firstRerunEvent","results","messages","map","getMessageAnalysis","rerunDuration","undefined","scriptRunStateAtStart","scriptRunState","requestToRerunStart","handleMessageEvents","curIndex","nextEventIndex","findNextMessageEvent","push","Error","first","last","messageAnalysis","duration","steps","ii","prevStep","thisStep","name","messageType","len","firstEventIndex","findRunStartEventIndex","slice","a","b","events","newSessionDecodedIndex","event","startIndex","getRerunAnalysis"],"sources":["../../src/profiler/RerunAnalyzer.ts"],"sourcesContent":["/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2024)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  DecodedMessageEvent,\n  HandleMessageEvent,\n  PerformanceEvent,\n  RequestedRerunEvent,\n} from \"@streamlit/lib/src/profiler/PerformanceEvents\"\nimport {\n  findNextEventIndex,\n  findPrevEvent,\n  findPrevEventIndex,\n  getTimeDelta,\n  isHandleMessageEvent,\n} from \"@streamlit/lib/src/profiler/Utils\"\n\ntype JSON = any\n\nclass RerunAnalyzer {\n  /** All the events that occurred in this rerun. */\n  private readonly rerunEvents: PerformanceEvent[]\n\n  /** The rerun request event that immediately preceded the rerun, if any. */\n  private readonly requestedRerun?: RequestedRerunEvent\n\n  public constructor(allEvents: PerformanceEvent[], lastEventIndex: number) {\n    const firstEventIndex = findRunStartEventIndex(allEvents, lastEventIndex)\n    if (firstEventIndex === undefined) {\n      throw new Error(\"Unable to find run start!\")\n    }\n\n    this.rerunEvents = allEvents.slice(firstEventIndex, lastEventIndex + 1)\n    this.requestedRerun = <RequestedRerunEvent>(\n      findPrevEvent(\n        allEvents,\n        firstEventIndex - 1,\n        evt => evt.name === \"RequestedRerun\"\n      )\n    )\n  }\n\n  public getResults = (): JSON => {\n    // Determine which messages were part of the run\n    const messageIndexes = new Set<number>()\n    this.rerunEvents.forEach(evt => {\n      if (isHandleMessageEvent(evt)) {\n        messageIndexes.add(evt.messageIndex)\n      }\n    })\n\n    if (messageIndexes.size === 0) {\n      return \"No rerun messages found!\"\n    }\n\n    // Analyze each message in the run\n    const sortedMessageIndexes =\n      Array.from(messageIndexes).sort(compareNumbers)\n\n    // Get the total duration of the run\n    const lastRerunEvent = this.rerunEvents[this.rerunEvents.length - 1]\n    const firstRerunEvent = this.rerunEvents[0]\n\n    const results: any = {\n      messages: sortedMessageIndexes.map(this.getMessageAnalysis),\n      rerunDuration: getTimeDelta(firstRerunEvent, lastRerunEvent),\n    }\n\n    // If we had a rerun request, include some additional stats\n    if (this.requestedRerun !== undefined) {\n      results.requestedRerun = true\n      results.scriptRunStateAtStart = this.requestedRerun.scriptRunState\n      results.requestToRerunStart = getTimeDelta(\n        this.requestedRerun,\n        firstRerunEvent\n      )\n    }\n\n    return results\n  }\n\n  private getMessageAnalysis = (messageIndex: number): any => {\n    // Get each event associated with the given message.\n    const handleMessageEvents: HandleMessageEvent[] = []\n    let curIndex = 0\n    while (curIndex < this.rerunEvents.length) {\n      const nextEventIndex = findNextMessageEvent(\n        this.rerunEvents,\n        curIndex,\n        messageIndex\n      )\n\n      if (nextEventIndex === undefined) {\n        break\n      }\n\n      handleMessageEvents.push(\n        <HandleMessageEvent>this.rerunEvents[nextEventIndex]\n      )\n      curIndex = nextEventIndex + 1\n    }\n\n    if (handleMessageEvents.length === 0) {\n      throw new Error(`No messages for the given index: ${messageIndex}`)\n    }\n\n    const first = handleMessageEvents[0]\n    const last = handleMessageEvents[handleMessageEvents.length - 1]\n\n    const messageAnalysis: any = {\n      messageIndex,\n      duration: getTimeDelta(first, last),\n      steps: [],\n    }\n\n    for (let ii = 1; ii < handleMessageEvents.length; ++ii) {\n      const prevStep = handleMessageEvents[ii - 1]\n      const thisStep = handleMessageEvents[ii]\n\n      if (thisStep.name === \"DecodedMessage\") {\n        messageAnalysis.messageType = thisStep.messageType\n        messageAnalysis.len = thisStep.len\n      }\n\n      messageAnalysis.steps.push({\n        name: thisStep.name,\n        duration: getTimeDelta(prevStep, thisStep),\n      })\n    }\n\n    return messageAnalysis\n  }\n}\n\nfunction compareNumbers(a: number, b: number): number {\n  if (a < b) {\n    return -1\n  }\n  if (a > b) {\n    return 1\n  }\n  return 0\n}\n\n/** Find the index of the first event in the run. */\nfunction findRunStartEventIndex(\n  events: PerformanceEvent[],\n  lastEventIndex: number\n): number | undefined {\n  const newSessionDecodedIndex = findPrevEventIndex(\n    events,\n    lastEventIndex - 1,\n    event =>\n      event.name === \"DecodedMessage\" && event.messageType === \"newSession\"\n  )\n\n  if (newSessionDecodedIndex === undefined) {\n    return undefined\n  }\n\n  // Find the newSession's \"BeginHandleMessage\" event\n  const { messageIndex } = <DecodedMessageEvent>events[newSessionDecodedIndex]\n\n  return findPrevEventIndex(\n    events,\n    newSessionDecodedIndex,\n    event =>\n      event.name === \"BeginHandleMessage\" &&\n      event.messageIndex === messageIndex\n  )\n}\n\n/** Find the next HandleMessageEvent index for the given message. */\nfunction findNextMessageEvent(\n  events: PerformanceEvent[],\n  startIndex: number,\n  messageIndex: number\n): number | undefined {\n  return findNextEventIndex(\n    events,\n    startIndex,\n    evt => isHandleMessageEvent(evt) && evt.messageIndex === messageIndex\n  )\n}\n\n/** Return a human-readable performance analysis of a single rerun. */\nexport function getRerunAnalysis(\n  allEvents: PerformanceEvent[],\n  lastEventIndex?: number\n): JSON {\n  return new RerunAnalyzer(\n    allEvents,\n    lastEventIndex ?? allEvents.length - 1\n  ).getResults()\n}\n"],"mappings":"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"}